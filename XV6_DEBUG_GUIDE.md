# xv6 å®Œæ•´è°ƒè¯•æŒ‡å—

## ğŸš€ ä¸€é”®è°ƒè¯•

### ä½¿ç”¨è„šæœ¬
```bash
# è¿è¡Œä¸€é”®è°ƒè¯•è„šæœ¬
./debug_xv6.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. ç¼–è¯‘ xv6
2. é…ç½® GDB ç¯å¢ƒ
3. å¯åŠ¨ QEMU è°ƒè¯•æ¨¡å¼
4. è¿æ¥ GDB å¹¶è®¾ç½®æ–­ç‚¹
5. æä¾›è°ƒè¯•æç¤º

## ğŸ”§ æ‰‹åŠ¨è°ƒè¯•æ­¥éª¤

### 1. ç¼–è¯‘é¡¹ç›®
```bash
make clean && make
```

### 2. å¯åŠ¨è°ƒè¯•æ¨¡å¼
```bash
# ç»ˆç«¯1ï¼šå¯åŠ¨ QEMU
make qemu-gdb

# ç»ˆç«¯2ï¼šå¯åŠ¨ GDB
gdb
```

### 3. GDB è°ƒè¯•å‘½ä»¤
```gdb
# è¿æ¥ QEMU
target remote localhost:25000

# åŠ è½½ç¬¦å·
symbol-file kernel

# è®¾ç½®æ–­ç‚¹
b main

# å¼€å§‹æ‰§è¡Œ
c
```

## ğŸ¯ CLion è°ƒè¯•é…ç½®

### æ–¹æ³•1ï¼šç›´æ¥é…ç½®è¿œç¨‹è°ƒè¯•
1. `Run` -> `Edit Configurations...`
2. `+` -> `GDB Remote Debug`
3. é…ç½®ï¼š
   - Name: `xv6 Debug`
   - Target: `localhost:25000`
   - Symbol file: `kernel`

### æ–¹æ³•2ï¼šä½¿ç”¨ CMakeï¼ˆæ¨èï¼‰
1. ä½¿ç”¨æä¾›çš„ `CMakeLists.txt`
2. é‡æ–°åŠ è½½é¡¹ç›®
3. é…ç½®è¿œç¨‹è°ƒè¯•
4. äº«å—å®Œæ•´ IDE ä½“éªŒ

## ğŸ“‹ å¸¸ç”¨è°ƒè¯•å‘½ä»¤

### GDB åŸºç¡€å‘½ä»¤
```gdb
c          # ç»§ç»­æ‰§è¡Œ
n          # å•æ­¥æ‰§è¡Œï¼ˆä¸è¿›å…¥å‡½æ•°ï¼‰
s          # å•æ­¥æ‰§è¡Œï¼ˆè¿›å…¥å‡½æ•°ï¼‰
list       # æŸ¥çœ‹ä»£ç 
p var      # æ‰“å°å˜é‡
bt         # æŸ¥çœ‹è°ƒç”¨æ ˆ
info reg   # æŸ¥çœ‹å¯„å­˜å™¨
x/10x addr # æŸ¥çœ‹å†…å­˜
```

### xv6 ç‰¹å®šè°ƒè¯•
```gdb
# åœ¨å…³é”®å‡½æ•°è®¾ç½®æ–­ç‚¹
b consoleinit
b userinit
b scheduler
b trap

# æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯
p *proc
p ptable

# æŸ¥çœ‹å†…å­˜æ˜ å°„
p *kpgdir
```

## ğŸ¨ CLion è°ƒè¯•æŠ€å·§

### 1. ä»£ç å¯¼èˆª
- `Ctrl+Click` è·³è½¬åˆ°å®šä¹‰
- `Ctrl+Alt+Left/Right` å‰è¿›/åé€€
- `Ctrl+Shift+F` å…¨å±€æœç´¢

### 2. è°ƒè¯•çª—å£
- Variablesï¼šæŸ¥çœ‹å˜é‡å€¼
- Memoryï¼šæŸ¥çœ‹å†…å­˜å†…å®¹
- Disassemblyï¼šæŸ¥çœ‹æ±‡ç¼–ä»£ç 
- Registersï¼šæŸ¥çœ‹å¯„å­˜å™¨çŠ¶æ€

### 3. æ–­ç‚¹ç®¡ç†
- æ¡ä»¶æ–­ç‚¹ï¼šå³é”®æ–­ç‚¹è®¾ç½®æ¡ä»¶
- æ—¥å¿—æ–­ç‚¹ï¼šä¸åœæ­¢æ‰§è¡Œï¼Œåªè¾“å‡ºæ—¥å¿—
- ä¸´æ—¶æ–­ç‚¹ï¼š`Ctrl+Alt+Shift+F8`

## ğŸ” è°ƒè¯•åœºæ™¯ç¤ºä¾‹

### 1. è°ƒè¯•å†…æ ¸å¯åŠ¨
```gdb
b main
c
# å•æ­¥æ‰§è¡Œå„ä¸ªåˆå§‹åŒ–å‡½æ•°
n
```

### 2. è°ƒè¯•ç³»ç»Ÿè°ƒç”¨
```gdb
b syscall
c
# æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨å·
p num
```

### 3. è°ƒè¯•è¿›ç¨‹è°ƒåº¦
```gdb
b scheduler
c
# æŸ¥çœ‹å½“å‰è¿›ç¨‹
p *c->proc
```

### 4. è°ƒè¯•ä¸­æ–­å¤„ç†
```gdb
b trap
c
# æŸ¥çœ‹ä¸­æ–­ç±»å‹
p tf->trapno
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šGDB è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ QEMU æ˜¯å¦å¯åŠ¨
ps aux | grep qemu

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 25000
```

### é—®é¢˜2ï¼šç¬¦å·æ–‡ä»¶åŠ è½½å¤±è´¥
```bash
# ç¡®ä¿ kernel æ–‡ä»¶å­˜åœ¨
ls -la kernel

# é‡æ–°ç¼–è¯‘
make clean && make
```

### é—®é¢˜3ï¼šCLion æ— æ³•è¯†åˆ«ä»£ç 
```bash
# é‡æ–°ç”Ÿæˆ CMake ç¼“å­˜
rm -rf cmake-build-*
# åœ¨ CLion ä¸­é‡æ–°åŠ è½½ CMake é¡¹ç›®
```

## ğŸ“š è¿›é˜¶è°ƒè¯•

### 1. å¤šæ ¸è°ƒè¯•
```gdb
# æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹
info threads

# åˆ‡æ¢çº¿ç¨‹
thread 2
```

### 2. å†…å­˜è°ƒè¯•
```gdb
# æŸ¥çœ‹é¡µè¡¨
x/10x kpgdir

# æŸ¥çœ‹ç‰©ç†å†…å­˜
x/100x 0x80000000
```

### 3. æ€§èƒ½åˆ†æ
```gdb
# è®¾ç½®è§‚å¯Ÿç‚¹
watch variable

# ç»Ÿè®¡å‡½æ•°è°ƒç”¨
break function
commands
silent
printf "Called %d times\n", ++count
continue
end
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä½¿ç”¨ä¸€é”®è„šæœ¬**ï¼šé¿å…é‡å¤é…ç½®
2. **CLion + CMake**ï¼šè·å¾—æœ€ä½³å¼€å‘ä½“éªŒ
3. **è®¾ç½®å¤šä¸ªæ–­ç‚¹**ï¼šè§‚å¯Ÿç³»ç»ŸçŠ¶æ€å˜åŒ–
4. **ä½¿ç”¨æ¡ä»¶æ–­ç‚¹**ï¼šå‡å°‘ä¸å¿…è¦çš„åœé¡¿
5. **ä¿å­˜è°ƒè¯•ä¼šè¯**ï¼šè®°å½•é‡è¦çš„è°ƒè¯•é…ç½®

## ğŸ“– å‚è€ƒèµ„æº

- [xv6 å®˜æ–¹æ–‡æ¡£](https://pdos.csail.mit.edu/6.828/)
- [GDB ç”¨æˆ·æ‰‹å†Œ](https://sourceware.org/gdb/documentation/)
- [QEMU è°ƒè¯•æŒ‡å—](https://qemu.readthedocs.io/en/latest/system/gdb.html)
